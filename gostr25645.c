#include "gostr25645.h"

#include <math.h>

/*
 * simple testing:
 * 
 *      $ cc ./gostr25645.c -lm -DTEST_GOSTR25645 -o ./gostr25645
 *      $ ./gostr25645 
 *      prepared: 
 *          F10_7    145.935
 *          F81      130.134
 *          Kp       1.60519
 *      rho(145.935, 130.134, 1.60519, 88.7655, 58738, 1.23457, 1234.57, 6789.01, 4567.89, 666.666, 4.56789, 0.12345) =
 *          5.05386e-14
 * 
 */

static const double EARTH_WROT  = 7.292115e-5;  /* [rad/s] */
static const double RHO_0       = 1.58868e-8;   /* [kg/m^3] */
static const double SOLAR_DT    = 1.7;          /* [days] */
static const double SOLAR_T0    = 20.00 / 24.0; /* [days] */
static const double GEOM_24H_DT = 0.6;          /* [days] */
static const double GEOM_3H_DT  = 0.3;          /* [days] */
static const double GEOM_T0     = 12.0 / 24.0;  /* [days] */

typedef struct {
    double F0;
    double a_h;
    double a[7];
    double b_h;
    double b[5];
    double c_h;
    double c[5];
    double n[3];
    double phi_1;
    double d_h;
    double d[5];
    double e_h;
    double e[9];
    double et[4];
    double l_h;
    double l[5];
} gostr25645_coefs;

/* Table-1 */
static const double A[9] = {
    -2.53418e-02,
    -2.44075e-03,
    +3.08389e-06,
    +2.90115e-06,
    -4.99606e-08,
    +3.36327e-10,
    -1.09660e-12,
    +1.73227e-15,
    -1.06271e-18
};
/* Table-2 */
static const gostr25645_coefs LOW[7] = {
{
    75, 120, 26.8629, -0.451674, 0.00290397, -1.06953e-5, 2.21598e-8, -2.42941e-11, 
    1.09926e-14, 120, 0.0687894, -0.00284077, 1.83922e-5, 9.19605e-9, -4.16873e-11, 120, 
    -1.04825, 0.0166305, -9.24263e-5, 2.72382e-7, -2.41355e-10, 2.058, 5.887e-3, -4.012e-6, 
    0.5411, 120, -0.351899, 0.00577056, 9.95819e-7, -7.25324e-9, 2.9759e-12, 120, 
    -0.731596, 0.00597345, -5.82037e-6, 6.84634e-8, -9.50483e-11, -0.20670, 9.7533e-2, -1.1817e-2, 
    1.6145e-3, -0.2061, 9.4449e-2, -8.7953e-3, 8.8385e-4, 120, -0.407768, 0.00148506, 
    1.25357e-5, 3.77311e-8, -7.78953e-11
},
{
    100, 120, 27.4598, -0.463668, 0.002974, -1.0753e-5, 2.17059e-8, -2.30249e-11, 
    1.00123e-14, 120, 0.15073, -0.00400889, 2.43937e-5, -9.92772e-9, -1.82239e-11, 120, 
    -0.93106, 0.0141537, -7.29862e-5, 2.00294e-7, -1.62006e-10, 2.058, 5.887e-3, -4.012e-6, 
    0.5515, 120, -0.047813, 0.00380813, 4.22771e-6, -8.66826e-9, 3.06712e-12, 120, 
    -0.752175, 0.00565925, 1.8082e-6, 3.33822e-8, -5.13965e-11, -0.16971, 7.9830e-2, -9.4393e-3, 
    1.2622e-3, -0.169279, 7.7599e-2, -7.1375e-3, 6.9025e-4, 120, -0.902739, 0.00826803, 
    -1.25448e-5, 6.12853e-8, -7.07966e-11
},
{
    125, 120, 28.6395, -0.490987, 0.00320649, -1.1681e-5, 2.36847e-8, -2.51809e-11, 
    1.09536e-14, 120, 0.0479451, -0.00239453, 1.70335e-5, -1.31626e-9, -1.74032e-11, 120, 
    -0.820867, 0.0119916, -5.79835e-5, 1.50707e-7, -1.13026e-10, 2.058, 5.887e-3, -4.012e-6, 
    0.5585, 120, 0.20981, 0.00262881, 4.24379e-6, -6.67328e-9, 2.13496e-12, 120, 
    -0.570476, 2.95802e-3, 1.68896e-5, -4.7475e-9, -1.72711e-11, -0.14671, 6.8808e-2, -7.9836e-3, 
    1.0535e-3, -0.146377, 6.7052e-2, -6.0951e-3, 5.7456e-4, 120, -0.733037, 0.00523396, 
    6.35667e-6, 1.09065e-8, -2.61427e-11
},
{
    150, 120, 29.6418, -0.514957, 0.00341926, -1.25785e-5, 2.5727e-8, -2.75874e-11, 
    1.21091e-14, 120, 0.0223448, -0.0019798, 1.54101e-5, -2.3543e-9, -1.24994e-11, 120, 
    -0.744047, 0.0104743, -4.78544e-5, 1.18513e-7, -8.31498e-11, 2.058, 5.887e-3, -4.012e-6, 
    0.5585, 120, 0.265174, 0.00275836, 2.08668e-6, -3.69543e-9, 1.11862e-12, 120, 
    -0.949573, 8.13121e-3, -3.87813e-6, 2.37694e-8, -2.77469e-11, -0.13150, 6.1603e-2, -7.0866e-3, 
    9.2813e-4, -0.13121, 6.0105e-2, -5.4388e-3, 5.0585e-4, 120, -1.31444, 0.0133124, 
    -2.55585e-5, 5.43981e-8, -4.33784e-11
},
{
    175, 120, 30.1671, -0.527837, 0.00353211, -1.30227e-5, 2.66455e-8, -2.85432e-11, 
    1.25009e-14, 120, -0.00326391, -0.00159869, 1.40443e-5, -3.02287e-9, -9.2016e-12, 120, 
    -0.722471, 0.00980317, -4.25245e-5, 9.95544e-8, -6.55175e-11, 2.058, 5.887e-3, -4.012e-6, 
    0.5585, 120, 0.23047, 0.00338331, -5.52305e-7, -8.23607e-10, 2.21349e-13, 120, 
    -0.967598, 8.41991e-3, -3.585e-6, 1.74801e-8, -1.96221e-11, -0.120916, 5.6538e-2, -6.4324e-3, 
    8.3723e-4, -0.12067, 5.5232e-2, -4.9580e-3, 4.5512e-4, 120, -1.20026, 0.0114087, 
    -1.47324e-5, 2.7804e-8, -2.2632e-11
},
{
    200, 120, 29.7578, -0.517915, 0.00342699, -1.24137e-5, 2.48209e-8, -2.58413e-11, 
    1.09383e-14, 120, -0.0514749, -0.000921059, 1.15147e-5, -1.22901e-9, -8.13104e-12, 120, 
    -0.687482, 0.00916594, -3.80932e-5, 8.51275e-8, -5.29972e-11, 2.058, 5.887e-3, -4.012e-6, 
    0.5585, 120, 0.170074, 0.00406131, -2.82114e-6, 1.38369e-9, -4.27908e-13, 120, 
    -1.02278, 9.23633e-3, -6.10128e-6, 1.78211e-8, -1.70073e-11, -0.11363, 5.3178e-2, -6.0436e-3, 
    7.7982e-4, -0.113399, 5.1994e-2, -4.6876e-3, 4.2548e-4, 120, -1.52158, 0.015704, 
    -3.02859e-5, 4.57668e-8, -2.82926e-11
},
{
    250, 120, 30.7854, -0.545695, 0.00370328, -1.37072e-5, 2.80614e-8, -3.00184e-11, 
    1.31142e-14, 120, -0.107255, -0.000174343, 9.02759e-6, -3.16512e-10, -6.14e-12, 120, 
    -0.739984, 0.00952854, -3.62727e-5, 7.3887e-8, -4.23907e-11, 2.058, 5.887e-3, -4.012e-6, 
    0.5585, 120, 0.088141, 0.00468253, -4.24609e-6, 2.53509e-9, -7.29031e-13, 120, 
    -0.757903, 0.00606068, 7.85296e-6, -9.74891e-9, 1.58377e-12, -0.10444, 4.8551e-2, -5.3567e-3, 
    6.8809e-4, -0.104243, 4.7573e-2, -4.1711e-3, 3.7068e-4, 120, -1.67664, 1.77194e-2, 
    -3.69498e-5, 5.09134e-8, -2.82878e-11
}
};
/* Table-3 */
static const gostr25645_coefs HIGH[7] = {
{
    75, 500, 17.8781, -0.132025, 0.000227717, -2.2543e-7, 1.33574e-10, -4.50458e-14, 
    6.72086e-18, 600, 23.1584, -0.0802147, 0.000105824, -6.15036e-8, 1.32453e-11, 640, 
    50.5034, -0.170541, 2.17232e-4, -1.21902e-7, 2.54037e-11, 2.058, 5.887e-3, -4.012e-6, 
    0.5411, 1500, -0.351899, 0.00577056, 9.95819e-7, -7.25324e-9, 2.9759e-12, 600, 
    38.6199, -0.132147, 1.75411e-4, -1.02417e-7, 2.21446e-11, -0.20670, 9.7533e-2, -1.1817e-2, 
    1.6145e-3, -0.2061, 9.4449e-2, -8.7953e-3, 8.8385e-4, 640, 48.6536, -0.170291, 
    2.26242e-4, -1.32032e-7, 2.85193e-11
},
{
    100, 500, -2.54909, 0.0140064, -0.00016946, 3.27196e-7, -2.8763e-10, 1.22625e-13, 
    -2.05736e-17, 660, 33.2732, -0.111099, 0.000141421, -7.94952e-8, 1.65836e-11, 700, 
    61.624, -0.192967, 2.28061e-4, -1.18715e-7, 2.29638e-11, 2.058, 5.887e-3, -4.012e-6, 
    0.5515, 1500, -0.047813, 0.00380813, 4.22771e-6, -8.66826e-9, 3.06712e-12, 700, 
    51.249, -0.167373, 2.11832e-4, -1.18221e-7, 2.45055e-11, -0.16971, 7.9830e-2, -9.4393e-3, 
    1.2622e-3, -0.169279, 7.7599e-2, -7.1375e-3, 6.9025e-4, 660, 54.4867, -0.178298, 
    2.22725e-4, -1.227e-7, 2.51316e-11
},
{
    125, 500, -13.9599, 0.0844951, -0.000328875, 5.05918e-7, -3.92299e-10, 1.52279e-13, 
    -2.35576e-17, 760, 39.1961, -0.12352, 0.000149015, -7.9705e-8, 1.58772e-11, 760, 
    53.2623, -0.144342, 1.4659e-4, -6.46443e-8, 1.04227e-11, 2.058, 5.887e-3, -4.012e-6, 
    0.5585, 1500, 0.20981, 0.00262881, 4.24379e-6, -6.67328e-9, 2.13496e-12, 780, 
    68.4746, -2.15659e-1, 2.62273e-4, -1.40972e-7, 2.82285e-11, -0.14671, 6.8808e-2, -7.9836e-3, 
    1.0535e-3, -0.146377, 6.7052e-2, -6.0951e-3, 5.7456e-4, 740, 60.1267, -0.183144, 
    2.12481e-4, -1.08497e-7, 2.0571e-11
},
{
    150, 500, -23.3079, 0.135141, -0.000420802, 5.73717e-7, -4.03238e-10, 1.42846e-13, 
    -2.01726e-17, 800, 43.2469, -0.126973, 0.000142637, -7.09985e-8, 1.31646e-11, 820, 
    18.2236, -0.00840024, -3.88e-5, 4.31384e-8, -1.23832e-11, 2.058, 5.887e-3, -4.012e-6, 
    0.5585, 1500, 0.265174, 0.00275836, 2.08668e-6, -3.69543e-9, 1.11862e-12, 800, 
    58.422, -1.66664e-1, 1.85486e-4, -9.12345e-8, 1.67118e-11, -0.13150, 6.1603e-2, -7.0866e-3, 
    9.2813e-4, -0.13121, 6.0105e-2, -5.4388e-3, 5.0585e-4, 800, 47.0996, -0.12526, 
    1.26352e-4, -5.51584e-8, 8.75272e-12
},
{
    175, 500, -14.7264, 0.0713256, -0.000228015, 2.8487e-7, -1.74383e-10, 5.08071e-14, 
    -5.34955e-18, 860, 49.5738, -0.138613, 0.000147851, -6.96361e-8, 1.21595e-11, 860, 
    -31.8442, 0.168327, -2.62603e-4, 1.65454e-7, -3.69355e-11, 2.058, 5.887e-3, -4.012e-6, 
    0.5585, 1500, 0.23047, 0.00338331, -5.52305e-7, -8.23607e-10, 2.21349e-13, 800, 
    7.20188, 2.16109e-2, -6.52882e-5, 5.37077e-8, -1.4095e-11, -0.120916, 5.6538e-2, -6.4324e-3, 
    8.3723e-4, -0.12067, 5.5232e-2, -4.9580e-3, 4.5512e-4, 860, 50.6174, -0.129047, 
    1.24842e-4, -5.24993e-8, 8.08272e-12
},
{
    200, 500, -4.912, 0.0108326, -8.10546e-5, 1.15712e-7, -8.13296e-11, 3.04913e14, 
    -4.94989e-18, 900, 11.278, 0.00143478, -3.69846e-5, 3.58318e-8, -9.91225e-12, 920, 
    -48.7208, 0.222996, -3.21884e-4, 1.91495e-7, -4.08067e-11, 2.058, 5.887e-3, -4.012e-6, 
    0.5585, 1500, 0.170074, 0.00406131, -2.82114e-6, 1.38369e-9, -4.27908e-13, 900, 
    21.5948, -2.02239e-2, -1.72029e-5, 2.83017e-8, -8.94486e-12, -0.11363, 5.3178e-2, -6.0436e-3, 
    7.7982e-4, -0.113399, 5.1994e-2, -4.6876e-3, 4.2548e-4, 900, 8.01942, 0.0185302, 
    -6.14733e-5, 4.97674e-8, -1.26162e-11
},
{
    250, 500, -5.40952, 0.00550749, -3.78851e-5, 2.4808e-8, 4.92183e-12, -8.65011e-15, 
    1.9849e-18, 1000, -52.6184, 0.214689, -0.000294882, 1.71171e-7, -3.60582e-11, 980, 
    -147.859, 0.531652, -671937e-4, 3.64787e-7, -7.26268e-11, 2.058, 5.887e-3, -4.012e-6, 
    0.5585, 1500, 0.088141, 0.00468253, -4.24609e-6, 2.53509e-9, -7.29031e-13, 760, 
    -88.4076, 0.338518, -0.000445581, 2.51729e-7, -5.203e-11, -0.10444, 4.8551e-2, -5.3567e-3, 
    6.8809e-4, -0.104243, 4.7573e-2, -4.1711e-3, 3.7068e-4, 900, -15.5728, 9.36704e-2, 
    -1.49036e-4, 9.42151e-8, -2.0961e-11
}
};

double rho_gostr25645(
    double F10_7, double F81, double Kp,
    double doy, double sod, double gst_midnight,
    double x, double y, double z, double h,
    double sun_ra, double sun_de
)
{
    int F0_index;
    int i, j;
    
    double rho;
    double rho_night, K0, K1, K2, K3, K4;
    double sin_sun_de, cos_sun_de, sin_beta, cos_beta;
    double r, Ad, phi_1, F0, beta, cosphi, cosphio2;
    const double *a, *b, *c, *d, *e, *l, *n;
    double h_power[7], Kp_power[4];
    
    double tmp1, tmp2;
    
    for (h_power[0] = 1.0, i = 1; i < 7; i++)
        h_power[i] = h_power[i-1] * h;
    for (Kp_power[0] = 1.0, i = 1; i < 4; i++)
        Kp_power[i] = Kp_power[i-1] * Kp;
    
    if (F81 <= LOW[0].F0)
        F0_index = 0;
    else if (F81 >= LOW[7-1].F0)
        F0_index = 7-1;
    else {
        for (F0_index = 0; F0_index < 7-1; F0_index++) {
            if (F81 >= LOW[F0_index].F0) {
                double df1 = F81 - LOW[F0_index].F0;
                double df2 = LOW[F0_index+1].F0 - F81;
                if (df2 < df1)
                    F0_index++;
                break;
            }
        }
    }
    F0 = LOW[F0_index].F0;
    
    a = (HIGH[F0_index].a_h > h) ? LOW[F0_index].a : HIGH[F0_index].a;
    b = (HIGH[F0_index].b_h > h) ? LOW[F0_index].b : HIGH[F0_index].b;
    c = (HIGH[F0_index].c_h > h) ? LOW[F0_index].c : HIGH[F0_index].c;
    d = (HIGH[F0_index].d_h > h) ? LOW[F0_index].d : HIGH[F0_index].d;
    e = (HIGH[F0_index].e_h > h) ? LOW[F0_index].e : HIGH[F0_index].e;
    l = (HIGH[F0_index].l_h > h) ? LOW[F0_index].l : HIGH[F0_index].l;
    n = LOW[F0_index].n;
    phi_1 = LOW[F0_index].phi_1;
    
    Ad = 0.0;
    for (tmp1 = 1.0, i = 0; i < 9; i++) {
        Ad += tmp1 * A[i];
        tmp1 *= doy;
    }
    
    r = sqrt(x*x + y*y + z*z);
    beta = sun_ra - gst_midnight - EARTH_WROT*sod + phi_1;
    
    /* minor premature optimization */
    #ifdef _GNU_SOURCE
    sincos(sun_de, &sin_sun_de, &cos_sun_de);
    sincos(beta, &sin_beta, &cos_beta);
    #else
    sin_sun_de = sin(sun_de);
    cos_sun_de = cos(sun_de);
    sin_beta = sin(beta);
    cos_beta = cos(beta);
    #endif
    
    cosphi = (z*sin_sun_de + cos_sun_de * (x*cos_beta + y*sin_beta)) / r;
    /* cos(x) = sqrt((cos(2x) + 1) / 2) */
    cosphio2 = sqrt((cosphi + 1.0) * 0.5);
    
    for (tmp1 = 0.0, i = 0; i < 5; i++) tmp1 += l[i] * h_power[i];
    K0 = 1.0 + tmp1 * (F81 - F0) / F0;
    
    for (tmp1 = 0.0, i = 0; i < 5; i++) tmp1 += c[i] * h_power[i];
    for (tmp2 = 0.0, i = 0; i < 3; i++) tmp2 += n[i] * h_power[i];
    K1 = tmp1 * pow(cosphio2, tmp2);
    
    for (tmp1 = 0.0, i = 0; i < 5; i++) tmp1 += d[i] * h_power[i];
    K2 = tmp1 * Ad;
    
    for (tmp1 = 0.0, i = 0; i < 5; i++) tmp1 += b[i] * h_power[i];
    K3 = tmp1 * (F10_7 - F81) / (F81 + fabs(F10_7 - F81));
    
    for (tmp1 = 0.0, i = 0; i < 5; i++) tmp1 += e[i] * h_power[i];
    for (tmp2 = 0.0, i = 0; i < 4; i++) tmp1 += e[i+5] * Kp_power[i];
    K4 = tmp1 * tmp2;
    
    for (tmp1 = 0.0, i = 0; i < 7; i++) tmp1 += a[i] * h_power[i];
    rho_night = RHO_0 * exp(tmp1);
    
    rho = rho_night * K0 * (1.0 + K1 + K2 + K3 + K4);

    return rho;
}

static double interpolate(const double *xs, const double *ys, int size, double x) {
    int i;
    for (i = size - 2; i > 0; i--)
        if (xs[i] < x)
            break;
    return ys[i] + (ys[i+1] - ys[i]) * (x - (double)xs[i]) / (double)(xs[i+1] - xs[i]);
}

void prepare_gostr25645(
    const double *hjd, const double *hF10_7, const double *hKp, int hsize,
    double jd,
    double *F10_7, double *F81, double *Kp
)
{
    int i, i0, i_81;
    double sum_f = 0.0;
    double sum_w = 0.0;
    double w, dw;
    
    if (hsize <= 0)
        return;
    if (hsize == 1) {
        *F81 = *F10_7 = hF10_7[0];
        *Kp = hKp[0];
        return;
    }
    
    if (jd >= hjd[hsize-1])
        i0 = hsize - 1;
    else {
        int left = 0, right = hsize - 1;
        while (right - left > 1) {
            int mid = (left + right) / 2;
            if (hjd[mid] < jd)
                left = mid;
            else
                right = mid;
        }
        i0 = right;
    }
    
    if (i0 <= 1) {
        *F81 = *F10_7 = hF10_7[0];
        *Kp = hKp[0];
        return;
    }
    
    if (hjd[0] >= hjd[i0] - 81.0)
        i_81 = 0;
    else {
        int left = 0, right = i0;
        while (right - left > 1) {
            int mid = (left + right) / 2;
            if (hjd[mid] < hjd[i0] - 81.0)
                left = mid;
            else
                right = mid;
        }
        i_81 = left;
    }
    
    hjd += i_81;
    hF10_7 += i_81;
    hKp += i_81;
    hsize -= i_81;
    i0 -= i_81;
    
    dw = 0.5 / (double)(i0 - 1);
    for (i = 0, w = 0.5; i < i0; i++, w += dw) {
        sum_f += hF10_7[i] * w;
        sum_w += w;
    }
    *F81 = sum_f / sum_w;
    
    *F10_7 = interpolate(hjd, hF10_7, i0+1, jd - SOLAR_DT);
    *Kp = interpolate(hjd, hKp, i0+1, jd - GEOM_24H_DT);
}


#ifdef TEST_GOSTR25645
#include <time.h>
#include <stdio.h>
#include <stdlib.h>
const char * DSD[] = {
    /* "#  Date     10.7cm Number  Hemis. Regions Field  Flux   C  M  X  S  1  2  3", */
    "2015 01 01  138    101      870      1    -999   B4.9   3  0  0  9  0  0  0",
    "2015 01 02  146    113     1250      1    -999   B4.9   3  0  0  9  0  0  0",
    "2015 01 03  149    122     1300      0    -999   B5.7  10  1  0 13  1  0  0",
    "2015 01 04  150    124     1220      0    -999   B6.7   5  1  0 13  0  1  0",
    "2015 01 05  142     89      920      0    -999   B7.2   6  0  0  8  1  1  0",
    "2015 01 06  142    102      680      2    -999   B7.2   6  0  0  4  1  0  0",
    "2015 01 07  147    106      490      0    -999   B7.0   6  0  0  6  1  0  0",
    "2015 01 08  157    101      550      1    -999   B8.0   5  0  0  3  1  0  0",
    "2015 01 09  151    125      980      2    -999   B7.7   5  0  0  2  1  0  0",
    "2015 01 10  152    146      940      1    -999   B6.9   5  0  0  7  0  0  0",
    "2015 01 11  154    133      980      0    -999   B8.2   8  0  0 15  0  0  0",
    "2015 01 12  159    111      950      0    -999   C1.0   7  0  0 18  0  0  0",
    "2015 01 13  146     93      840      0    -999   B7.5   3  2  0  5  0  1  0",
    "2015 01 14  142     89      570      0    -999   B9.1  14  1  0 10  0  0  0",
    "2015 01 15  131     62      270      1    -999   B6.5   5  0  0  5  0  0  0",
    "2015 01 16  125     75      220      1    -999   B5.2   1  0  0  8  0  0  0",
    "2015 01 17  122     49      120      0    -999   B4.6   0  0  0  5  0  0  0",
    "2015 01 18  126     78      150      2    -999   B4.6   2  0  0  3  0  0  0",
    "2015 01 19  130     62      250      1    -999   B5.1   3  0  0  2  0  0  0",
    "2015 01 20  126     57      210      0    -999   B4.9   2  0  0  1  0  0  0",
    "2015 01 21  124     50      160      0    -999   B6.0   7  0  0  2  0  0  0",
    "2015 01 22  120     63      370      2    -999   B4.5   6  1  0  0  0  0  0",
    "2015 01 23  121     70      530      1    -999   B4.1   6  0  0  7  0  0  0",
    "2015 01 24  125     57      540      0    -999   B3.6   3  0  0  2  1  0  0",
    "2015 01 25  127     65      460      1    -999   B4.3   4  0  0  0  0  0  0",
    "2015 01 26  147    110      580      4    -999   B7.0   6  1  0 14  0  0  0",
    "2015 01 27  158    119      840      0    -999   B9.6   5  0  0 16  0  0  0",
    "2015 01 28  159    140      850      2    -999   B9.5   6  2  0  7  1  1  0",
    "2015 01 29  165    181     1160      1    -999   B9.4  16  1  0 20  3  0  0",
    "2015 01 30  159    193     1450      0    -999   B8.6   4  3  0  4  0  0  0",
    "2015 01 31  154    153     1320      0    -999   B6.3   5  0  0  2  0  0  0",
    "2015 02 01  142    132     1030      0    -999   B7.0   6  0  0  6  0  1  0",
    "2015 02 02  144    117      680      2    -999   B6.8   3  0  0  9  1  0  0",
    "2015 02 03  149    112      830      1    -999   B7.8   7  0  0 22  1  0  0",
    "2015 02 04  145     85      700      0    -999   B7.5   2  1  0 13  0  1  0",
    "2015 02 05  142     86      560      0    -999   B5.9   3  0  0  4  1  0  0",
    "2015 02 06  143     71      440      0    -999   B6.2   3  0  0 10  0  0  0",
    "2015 02 07  153     80      480      1    -999   B7.5   7  0  0  7  0  0  0",
    "2015 02 08  153     94      510      0    -999   B7.3   7  0  0 16  2  0  0",
    "2015 02 09  146     82      470      0    -999   B8.0   9  1  0 15  0  0  0",
    "2015 02 10  141     82      610      0    -999   B9.1   5  0  0 10  1  0  0",
    "2015 02 11  131     76      510      0    -999   B5.2   2  0  0  3  0  0  0",
    "2015 02 12  128     50      400      1    -999   B4.6   2  0  0  4  1  0  0",
    "2015 02 13  125     59      290      1    -999   B4.3   0  0  0  3  0  0  0",
    "2015 02 14  120     49      250      0    -999   B3.8   0  0  0  1  0  0  0",
    "2015 02 15  120     45      240      1    -999   B3.6   0  0  0  1  0  0  0",
    "2015 02 16  118     44      220      0    -999   B3.6   0  0  0  0  0  0  0",
    "2015 02 17  119     40      180      0    -999   B3.8   0  0  0  1  0  0  0",
    "2015 02 18  121     95      250      5    -999   B4.0   2  0  0  7  1  0  0",
    "2015 02 19  119     86      240      0    -999   B3.8   2  0  0  5  0  0  0",
    "2015 02 20  120     53      100      0    -999   B4.2   3  0  0  6  0  0  0",
    "2015 02 21  116     54      110      0    -999   B3.3   2  0  0  1  0  0  0",
    "2015 02 22  118     49       70      1    -999   B3.0   0  0  0  0  0  0  0",
    "2015 02 23  117     44       80      1    -999   B3.3   1  0  0  1  0  0  0",
    "2015 02 24  114     63      120      0    -999   B2.8   1  0  0  1  0  0  0",
    "2015 02 25  111     64      100      0    -999   B2.8   0  0  0  0  0  0  0",
    "2015 02 26  111     39       70      1    -999   B2.5   0  0  0  0  0  0  0",
    "2015 02 27  118     58      200      1    -999   B3.3   1  0  0  3  0  0  0",
    "2015 02 28  123     70      220      0    -999   B4.4   7  0  0  7  0  0  0",
    "2015 03 01  128     66      210      0    -999   B6.2   3  0  0 10  0  0  0",
    "2015 03 02  130     65      170      0    -999   B9.4  14  4  0  4  1  0  0",
    "2015 03 03  125     38      140      0    -999   B5.2   5  1  0  4  0  0  0",
    "2015 03 04  124     43      250      0    -999   B5.1   3  0  0  4  1  0  0",
    "2015 03 05  130     31       75      1    -999   B6.7   4  1  0  0  0  0  0",
    "2015 03 06  127     37       50      2    -999   C1.0   6  2  0  1  0  0  0",
    "2015 03 07  138     20      180      0    -999   B5.9   4  1  0  2  0  0  0",
    "2015 03 08  124     23      260      0    -999   B6.6   2  0  0  6  2  0  0",
    "2015 03 09  123     29      260      0    -999   B5.0  13  2  0 14  6  1  0",
    "2015 03 10  121     42      280      0    -999   B5.4  13  2  0 21  0  1  0",
    "2015 03 11  132     42      360      1    -999   B6.8  14  3  1  8  3  1  0",
    "2015 03 12  127     56      360      1    -999   B9.5  10  5  0  0  0  1  0",
    "2015 03 13  119     87      470      2    -999   B4.8   6  2  0  4  0  0  0",
    "2015 03 14  116     56      350      0    -999   B4.1  12  1  0 13  1  1  0",
    "2015 03 15  114     54      390      0    -999   B4.6   7  2  0 11  2  0  0",
    "2015 03 16  117     57      390      0    -999   B3.6   6  1  0  9  2  1  0",
    "2015 03 17  114     60      810      2    -999   B3.3   2  1  0  4  0  1  0",
    "2015 03 18  115     44      470      0    -999   B6.0  18  0  0 18  1  0  0",
    "2015 03 19  109     71      420      1    -999   B3.5   2  0  0  8  0  0  0",
    "2015 03 20  113     27      120      0    -999   B4.8   1  0  0  0  0  0  0",
    "2015 03 21  114     40      260      2    -999   B4.0   2  0  0  0  0  0  0",
    "2015 03 22  122     88      380      3    -999   B4.0   2  0  0  0  0  0  0",
    "2015 03 23  128    119      540      3    -999   B4.7   3  0  0  2  0  0  0",
    "2015 03 24  133    127      580      1    -999   B4.8   2  0  0  8  0  0  0",
    "2015 03 25  138    115      650      0    -999   B5.4   8  0  0  8  1  0  0",
    "2015 03 26  136    103      590      1    -999   B4.5   4  0  0  5  0  0  0",
    "2015 03 27  138    109      600      0    -999   B5.0   5  0  0  8  0  0  0",
    "2015 03 28  146     82      580      1    -999   B7.9  10  0  0 12  0  0  0",
    "2015 03 29  145     73      450      1    -999   B9.1   8  0  0 16  0  0  0",
    "2015 03 30  134     56      490      0    -999   B6.6   5  0  0  0  0  0  0",
    "2015 03 31  128     53      350      0    -999   B4.7   0  0  0  0  0  0  0"
};
const char * DGD[] = {
    /* "#  Date        A     K-indices        A     K-indices        A     K-indices", */
    "2015 01 01     7  2 2 1 1 2 2 2 3     5  1 1 2 1 2 2 1 2     7  2 1 1 1 1 2 2 3",
    "2015 01 02     8  3 1 1 2 2 2 2 3    17  2 2 3 2 5 2 4 3    12  3 1 2 2 3 2 3 4",
    "2015 01 03    13  4 2 3 3 3 3 2 1    18  4 3 3 5 4 2 1 0    15  5 3 3 3 3 2 2 1",
    "2015 01 04    15  0 0 3 4 4 3 2 4    48  0 0 4 7 6 6 4 4    21  1 1 2 4 4 5 4 5",
    "2015 01 05    10  4 2 2 2 2 2 2 2    18  4 3 4 3 3 3 3 3    18  5 3 3 2 2 2 3 3",
    "2015 01 06    11  2 2 3 3 2 3 3 1    20  2 2 4 5 4 4 3 0    13  2 3 3 4 2 3 3 2",
    "2015 01 07    23  2 2 5 5 4 3 2 4    59  2 0 7 8 5 3 3 2    38  3 1 6 7 4 2 3 4",
    "2015 01 08    15  3 5 3 2 2 3 1 2    23  3 3 3 4 5 5 2 2    16  4 4 3 2 2 3 2 3",
    "2015 01 09     7  2 1 3 2 2 2 1 1     8  2 1 2 2 4 2 1 0     8  3 2 3 2 2 2 2 2",
    "2015 01 10     9  1 3 2 2 3 3 2 1    18  1 2 2 5 5 4 1 0    10  2 3 2 2 3 3 1 0",
    "2015 01 11     8  3 1 3 2 2 1 2 1    18  1 1 5 5 4 2 2 1    10  3 2 3 2 2 1 2 2",
    "2015 01 12     7  1 1 1 2 3 2 2 2    16  0 1 1 3 6 3 2 2     8  0 1 1 2 3 2 3 2",
    "2015 01 13     5  1 1 1 1 2 2 2 2    13  1 1 1 3 5 3 2 2     8  2 2 1 2 3 2 2 2",
    "2015 01 14     5  2 1 1 2 2 2 1 1    12  1 1 1 4 5 2 1 0     7  2 1 2 2 3 1 2 1",
    "2015 01 15     5  1 1 1 1 3 2 1 1    14  0 0 4 3 5 3 1 1     6  1 1 2 1 3 2 1 1",
    "2015 01 16     6  1 2 2 1 2 2 2 1    10  0 1 3 4 4 1 1 1     7  1 3 2 2 2 1 2 2",
    "2015 01 17     5  3 2 0 2 1 0 1 1     2  0 1 0 3 0 0 0 0     7  3 3 1 2 1 0 1 2",
    "2015 01 18     3  0 2 0 0 2 1 2 1     2  0 0 0 1 1 1 0 1     5  0 1 0 1 2 1 2 2",
    "2015 01 19     2  2 0 0 0 1 1 1 1     2  0 0 0 1 1 2 1 1     5  3 1 1 1 1 1 1 2",
    "2015 01 20     5  1 1 2 2 1 1 1 2     4  1 0 1 4 0 0 0 0     4  1 1 2 1 1 0 1 1",
    "2015 01 21     7  2 2 1 1 1 2 3 2    10  0 0 0 1 4 4 3 2    11  2 2 2 1 2 3 4 3",
    "2015 01 22     9  3 3 2 2 2 2 2 2    19  3 3 1 5 5 3 2 1    12  4 3 2 3 3 2 2 2",
    "2015 01 23     8  2 3 2 2 2 2 2 1     8  2 2 2 2 3 3 1 1     9  3 3 3 2 2 2 2 1",
    "2015 01 24     5  0 1 1 2 2 2 1 2     7  0 0 0 3 4 2 1 1     7  1 2 1 2 2 2 2 2",
    "2015 01 25     3  0 1 0 0 1 1 1 3     4  0 0 0 3 2 2 1 1     6  1 2 1 0 1 1 1 3",
    "2015 01 26    12  3 2 3 4 3 2 2 1    19  2 1 4 5 4 4 2 1    16  3 3 3 4 3 3 2 2",
    "2015 01 27     9  3 2 3 2 2 2 2 2    13  2 2 3 4 3 3 2 2    12  3 3 3 2 2 3 3 3",
    "2015 01 28     5  2 1 3 2 1 1 0 1    14  2 2 3 5 4 1 1 1     7  3 2 3 2 1 1 1 1",
    "2015 01 29     7  2 1 1 1 2 2 3 2     8  1 0 1 3 2 3 3 2     9  2 1 1 2 2 2 4 3",
    "2015 01 30     8  2 3 2 1 1 2 3 2     9  1 2 3 3 2 2 2 2    11  3 3 2 1 1 2 3 3",
    "2015 01 31     6  1 2 1 1 1 2 2 3     8  1 2 0 3 2 3 2 2     9  2 2 1 2 2 2 2 4",
    "2015 02 01    11  3 1 2 2 2 3 3 3    17  3 1 2 3 3 4 4 4    21  4 3 3 2 2 3 4 5",
    "2015 02 02    17  4 4 3 3 3 3 3 2    44  4 5 5 6 4 6 4 3    27  5 5 4 4 3 4 4 3",
    "2015 02 03    12  3 4 2 2 2 2 2 3    28  3 3 5 5 4 5 3 2    17  4 4 3 2 2 3 3 3",
    "2015 02 04     5  2 1 1 2 2 2 1 1    14  1 2 2 3 5 3 2 2     9  3 2 2 2 3 3 1 2",
    "2015 02 05    10  1 3 1 3 3 3 2 2    21  0 2 1 3 5 6 2 2    13  2 3 1 3 3 4 3 2",
    "2015 02 06     4  0 1 2 2 2 2 1 0     4  1 1 1 2 2 1 1 0     5  1 1 2 2 2 1 1 0",
    "2015 02 07     9  1 0 3 4 2 2 1 2    23  0 0 3 6 5 4 2 1     9  1 0 3 3 2 3 2 2",
    "2015 02 08     7  1 2 2 2 2 2 2 2    14  1 2 5 4 2 2 2 2    10  2 3 3 2 2 2 3 3",
    "2015 02 09     5  2 0 1 0 2 2 2 2     7  2 0 0 1 4 3 1 1     8  3 1 1 1 3 2 2 3",
    "2015 02 10     6  1 2 1 1 2 2 2 2     3  0 1 0 0 2 1 1 2     7  1 3 1 1 1 2 2 3",
    "2015 02 11     5  2 3 0 0 2 2 1 1     8  1 1 0 2 5 1 0 0     7  2 3 1 1 2 1 0 1",
    "2015 02 12     3  1 0 0 1 2 1 1 1     4  0 0 0 0 3 3 1 0     5  2 1 1 1 2 2 2 1",
    "2015 02 13     2  0 0 0 1 2 1 1 1     2  0 0 0 3 1 0 0 0     3  0 0 0 1 1 1 1 1",
    "2015 02 14     2  0 1 1 0 1 1 1 1     0  0 0 0 0 0 0 0 1     3  0 1 1 1 0 0 1 1",
    "2015 02 15     5  0 2 2 1 3 1 1 1    11  1 0 2 3 5 3 1 0     6  1 2 2 2 3 1 1 1",
    "2015 02 16     4  0 1 0 1 2 1 2 2     3  0 0 2 2 1 0 1 1     5  0 1 1 1 1 1 2 3",
    "2015 02 17    18  3 2 3 3 3 3 3 5    27  2 2 3 6 3 5 3 4    22  3 3 3 4 3 3 4 5",
    "2015 02 18    15  5 3 3 3 2 2 2 2    28  4 4 5 5 5 3 2 1    19  5 4 3 3 2 2 2 3",
    "2015 02 19     5  2 2 2 1 1 2 1 1     8  1 2 3 1 3 3 1 1     8  3 3 2 1 1 2 2 2",
    "2015 02 20     4  0 2 2 1 2 1 1 1     7  1 0 2 3 4 1 0 1     6  1 2 2 2 2 1 1 2",
    "2015 02 21     8  3 3 1 1 2 2 2 2     6  2 2 2 3 1 1 0 1     7  3 3 1 1 2 1 1 2",
    "2015 02 22     6  2 1 1 2 2 2 1 2     7  1 2 1 3 3 2 1 0     7  3 2 1 2 1 1 1 2",
    "2015 02 23    14  3 2 2 3 3 4 2 3    25  2 1 4 5 5 5 3 2    17  3 3 3 3 3 4 3 4",
    "2015 02 24    21  5 4 4 4 2 3 2 2    41  5 5 6 6 5 3 2 1    25  5 5 4 4 3 2 2 3",
    "2015 02 25     7  2 1 3 2 3 2 1 0    20  0 0 3 6 5 2 2 0     9  1 1 3 2 3 2 1 1",
    "2015 02 26     5  2 1 2 1 1 2 1 1     8  1 0 4 3 3 1 0 0     5  2 1 2 2 1 0 1 1",
    "2015 02 27     2  0 0 0 0 1 2 1 1     1  0 0 0 0 1 1 0 1     4  1 0 1 1 1 1 1 2",
    "2015 02 28    11  1 2 3 1 2 4 2 3    18  1 1 3 4 3 5 3 3    13  1 3 3 2 2 4 3 3",
    "2015 03 01    23  5 4 5 4 3 2 2 2    36  4 5 5 7 2 1 2 2    28  5 5 5 4 2 2 2 3",
    "2015 03 02    18  4 3 4 4 3 3 3 1    60  3 5 8 6 5 4 3 1    28  4 4 5 5 4 4 3 2",
    "2015 03 03    10  3 3 2 2 2 2 1 3    21  1 2 3 6 5 1 1 2    11  3 3 2 2 2 1 2 3",
    "2015 03 04     9  1 1 1 3 3 2 2 3    12  1 1 1 5 4 1 1 1    10  2 2 2 3 3 1 2 3",
    "2015 03 05     5  0 0 0 1 3 2 2 2     7  0 0 0 3 4 2 2 1     6  1 1 1 2 2 2 2 2",
    "2015 03 06     9  1 2 4 2 2 2 2 2    17  1 3 5 4 4 2 2 1    13  2 3 4 3 2 2 3 3",
    "2015 03 07    17  4 4 3 3 1-1-1 3    27  3 4 5 5 2-1-1 3    20  4 4 3 3 2 4 3 4",
    "2015 03 08     7  2 2 2 2 3 2 1 1    24  3 1 5 5 5 4 1 1    11  3 2 3 3 4 2 2 1",
    "2015 03 09     6  4 1 0 0 2 2 1 1     2  1 1 0 0 0 1 1 0     6  3 2 1 0 1 1 1 1",
    "2015 03 10     4  1 1 2 2 1 2 1 0     6  1 1 1 4 1 1 1 0     5  2 2 2 2 1 1 1 1",
    "2015 03 11     8  0 3 2 2 2 3 2 1    14  1 2 3 3 4 4 3 1     9  1 3 2 2 2 3 2 1",
    "2015 03 12     6  1 3 2 2 2 2 1 0    13  1 2 3 5 3 2 2 0     8  2 3 2 3 2 2 1 0",
    "2015 03 13     5  1 0 0 1 3 3 1 1    -1  1-1-1-1-1-1-1-1     6  1 1 1 1 3 2 1 1",
    "2015 03 14     5  0 2 1 2 2 2 1 2    -1  1-1-1-1-1-1-1-1     5  1 2 2 2 2 1 1 2",
    "2015 03 15     7  1 2 3 1 2 2 2 2    -1 -1-1-1-1-1-1-1-1     7  2 2 3 2 1 2 2 1",
    "2015 03 16     9  2 3 3 2 2 2 2 2     0 -1-1-1-1-1-1 0 0    11  2 3 3 3 2 3 1 1",
    "2015 03 17    46  2 4 5 4 6 5 5 6   106  2 3 6 6 8 8 7 5   117  2 5 6 6 8 8 7 8",
    "2015 03 18    32  5 4 3 4 5 5 3 4    60  4 4 6 6 6 7 4 3    52  6 5 4 5 5 6 5 5",
    "2015 03 19    19  4 4 3 4 4 2 2 3    47  3 4 5 6 7 4 4 3    28  4 4 4 5 5 3 3 4",
    "2015 03 20    18  4 2 4 3 3 3 2 4    32  4 3 5 6 4 3 4 3    24  5 3 5 3 3 3 3 5",
    "2015 03 21    12  4 2 3 3 2 2 2 2    18  3 2 5 4 4 2 2 1    14  4 3 4 3 2 2 2 2",
    "2015 03 22    16  2 3 5 4 3 2 1 1    39  2 3 7 5 6 3 1 1    24  2 3 6 4 4 1 1 1",
    "2015 03 23    16  4 4 2 3 3 3 2 3    31  3 4 3 5 5 6 2 2    21  4 5 3 3 4 3 2 3",
    "2015 03 24     9  2 1 2 2 3 3 2 2    15  2 1 0 4 4 5 2 1    12  2 2 2 2 3 4 2 2",
    "2015 03 25    10  2 2 2 3 3 2 3 2    20  2 2 3 6 3 3 3 1    13  2 2 3 4 3 2 3 2",
    "2015 03 26     7  1 1 2 1 2 2 2 3     5  2 1 2 0 2 2 1 2     8  2 1 2 1 2 2 2 3",
    "2015 03 27     7  2 2 1 2 3 2 1 2    14  2 3 2 3 4 4 2 1     9  3 3 2 2 3 1 1 2",
    "2015 03 28     9  0 1 3 2 2 3 2 3     6  0 2 3 3 1 1 1 1     9  0 2 3 3 2 2 2 3",
    "2015 03 29    11  3 3 3 2 3 1 2 2    14  4 3 3 3 4 2 1 1    14  4 3 3 3 3 1 2 2",
    "2015 03 30     5  2 2 0 1 3 1 1 1     3  2 2 1 2 0 0 0 0     5  2 2 1 1 1 1 1 2",
    "2015 03 31     7  1 1 2 2 3 2 2 2     7  0 1 2 3 3 2 2 1     9  1 1 2 2 3 2 3 2"
};

int main(int argc, char *argv[]) {
    double *hjd, *hF10_7, *hKp;
    int i, hsize;
    double jd;
    
    double F10_7 = 123.456;
    double F81 = 98.765;
    double Kp = 3.4567;
    time_t now = time(NULL);
    double doy = gmtime(&now)->tm_yday;
    double sod = fmod(now, 86400.0);
    double gst_midnight = 1.2345678;
    double x = 1234.5678;
    double y = 6789.0123;
    double z = 4567.8901;
    double h = 666.666;
    double sun_ra = 4.56789;
    double sun_de = 0.12345;
    double rho;
    
    hsize  = sizeof(DGD) / sizeof(DGD[0]);
    hjd    = (double*)malloc(hsize * sizeof(double));
    hF10_7 = (double*)malloc(hsize * sizeof(double));
    hKp    = (double*)malloc(hsize * sizeof(double));
    
    for (i = 0; i < hsize; i++) {
        static const int months_nonleap[12] = {31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31};
        static const int months_leap[12] = {31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31};
        
        const int *months;
        int year, month, day, j;
        double flux, kp[8], daily_kp, nday;
        
        sscanf(DSD[i], "%d %d %d %lf", &year, &month, &day, &flux);
        sscanf(&DGD[i][68], "%lf %lf %lf %lf %lf %lf %lf %lf", 
            &kp[0], &kp[1], &kp[2], &kp[3], &kp[4], &kp[5], &kp[6], &kp[7]);
        
        for (daily_kp = 0.0, j = 0; j < 8; j++)
            daily_kp += kp[j] / 8.0;
        
        if ((year % 4 == 0) && ((year % 100 != 0) || (year % 400 == 0)))
            months = months_leap;
        else
            months = months_nonleap;
        
        for (nday = 0.0, j = 0; j < month-1; j++)
            nday += months[j];
        nday += day;
        
        hjd[i] = nday;
        hF10_7[i] = flux;
        hKp[i] = daily_kp;
    }
    jd = doy = hjd[hsize-1] - 1.2345;
    
    prepare_gostr25645(hjd, hF10_7, hKp, hsize, jd, &F10_7, &F81, &Kp);
    
    free(hjd);
    free(hF10_7);
    free(hKp);
    
    printf("prepared: \n"
           "    F10_7    %lg\n"
           "    F81      %lg\n"
           "    Kp       %lg\n",
        F10_7, F81, Kp);
    
    if (argc >  1 && argv[ 1][0] != '.') F10_7  = atof(argv[ 1]);
    if (argc >  2 && argv[ 2][0] != '.') F81    = atof(argv[ 2]);
    if (argc >  3 && argv[ 3][0] != '.') Kp     = atof(argv[ 3]);
    if (argc >  4 && argv[ 4][0] != '.') doy    = atof(argv[ 4]);
    if (argc >  5 && argv[ 5][0] != '.') sod    = atof(argv[ 5]);
    if (argc >  6 && argv[ 6][0] != '.') gst_midnight = atof(argv[ 6]);
    if (argc >  7 && argv[ 7][0] != '.') x      = atof(argv[ 7]);
    if (argc >  8 && argv[ 8][0] != '.') y      = atof(argv[ 8]);
    if (argc >  9 && argv[ 9][0] != '.') z      = atof(argv[ 9]);
    if (argc > 10 && argv[10][0] != '.') h      = atof(argv[10]);
    if (argc > 11 && argv[11][0] != '.') sun_ra = atof(argv[11]);
    if (argc > 12 && argv[12][0] != '.') sun_de = atof(argv[12]);
    
    rho = rho_gostr25645(F10_7, F81, Kp, doy, sod, gst_midnight,
        x, y, z, h, sun_ra, sun_de);
    printf("rho(%lg, %lg, %lg, %lg, %lg, %lg, %lg, %lg, %lg, %lg, %lg, %lg) =\n"
           "    %lg\n",
        F10_7, F81, Kp, doy, sod, gst_midnight,
        x, y, z, h, sun_ra, sun_de, rho);
    
    return 0;
}
#endif /* TEST_GOTR25645 */
